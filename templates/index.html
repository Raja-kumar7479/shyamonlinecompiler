<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>shyamonlinecompiler</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.15.2/ace.js"></script>
  <style>
    :root {
        --primary-color: #0d9488;
        --primary-hover: #0f766e;
        --dark-bg: #1e1e1e;
        --darker-bg: #121212;
        --border-color: #2d2d2d;
        --text-light: #e0e0e0;
        --resizer-height: 6px;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: #f8f9fa;
        overflow: hidden;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .navbar {
        background-color: var(--darker-bg);
        border-bottom: 1px solid var(--border-color);
        height: 60px;
        flex-shrink: 0;
        z-index: 1000;
    }

    .navbar-brand {
        font-weight: 700;
        color: #fff !important;
        font-size: 1.5rem;
        letter-spacing: 0.5px;
    }

    .navbar-brand i {
        color: var(--primary-color);
        margin-right: 8px;
    }

    #main-content-wrapper {
        flex-grow: 1;
        overflow: hidden;
        position: relative;
    }

    #problem-list-page {
        height: 100%;
        overflow-y: auto;
        background-color: #f8f9fa;
    }

    .problem-list-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }

    .search-filter-bar {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .problem-item {
        background: white;
        border-radius: 10px;
        margin-bottom: 12px;
        padding: 16px 20px;
        border: 1px solid #e9ecef;
        transition: all 0.2s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }

    .problem-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border-color: var(--primary-color);
    }

    .badge-difficulty {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
        border-radius: 50rem;
        text-transform: uppercase;
        font-weight: 600;
    }

    .diff-easy { background-color: #d1fae5; color: #065f46; }
    .diff-medium { background-color: #fef3c7; color: #b45309; }
    .diff-hard { background-color: #fee2e2; color: #991b1b; }

    #compiler-page {
        height: 100%;
        display: flex;
        flex-direction: row;
    }

    .left-panel {
        width: 40%;
        height: 100%;
        overflow-y: auto;
        background: white;
        border-right: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
    }

    .right-panel {
        width: 60%;
        height: 100%;
        display: flex;
        flex-direction: column;
        background-color: var(--dark-bg);
    }

    .panel-header {
        padding: 15px 20px;
        background: white;
        border-bottom: 1px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .problem-content {
        padding: 24px;
        line-height: 1.6;
        color: #333;
    }

    .editor-toolbar {
        background-color: #2d2d2d;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #3e3e3e;
    }

    .custom-select-dark {
        background-color: #3e3e3e;
        color: #fff;
        border: 1px solid #555;
        padding: 5px 10px;
        border-radius: 4px;
    }

    .editor-wrapper {
        flex-grow: 1;
        position: relative;
    }

    #editor {
        position: absolute;
        top: 0; right: 0; bottom: 0; left: 0;
    }

    #results-resize-handle {
        height: var(--resizer-height);
        background-color: #2d2d2d;
        cursor: row-resize;
        border-top: 1px solid #3e3e3e;
        border-bottom: 1px solid #3e3e3e;
        transition: background-color 0.2s;
    }

    #results-resize-handle:hover {
        background-color: var(--primary-color);
    }

    .results-panel {
        height: 200px;
        background-color: var(--darker-bg);
        color: var(--text-light);
        display: flex;
        flex-direction: column;
    }

    .results-tabs {
        display: flex;
        background-color: #1a1a1a;
        border-bottom: 1px solid #333;
    }

    .tab-btn {
        background: transparent;
        border: none;
        color: #888;
        padding: 8px 16px;
        font-size: 0.9rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }

    .tab-btn:hover { color: #ccc; background-color: #252525; }
    .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background-color: #252525; }

    .tab-content-area {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0;
        position: relative;
    }

    .tab-pane { display: none; height: 100%; }
    .tab-pane.active { display: block; }

    .btn-primary-custom {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        font-weight: 600;
    }
    .btn-primary-custom:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
    }

    .test-case-card {
        background-color: #252525;
        border: 1px solid #333;
        border-radius: 6px;
        margin-bottom: 10px;
    }
    
    .test-case-header {
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #333;
    }

    .test-case-body {
        padding: 15px;
        font-family: monospace;
        font-size: 0.9rem;
    }

    .status-pass { color: #4ade80; }
    .status-fail { color: #f87171; }
    .bg-pass { background-color: rgba(74, 222, 128, 0.1); border-left: 3px solid #4ade80; }
    .bg-fail { background-color: rgba(248, 113, 113, 0.1); border-left: 3px solid #f87171; }

    #custom-input textarea {
        width: 100%;
        height: 100%;
        background-color: #1e1e1e;
        color: #e0e0e0;
        border: none;
        padding: 15px;
        resize: none;
        font-family: monospace;
    }

    @media (max-width: 768px) {
        #compiler-page {
            flex-direction: column;
        }
        .left-panel {
            width: 100%;
            height: 40%;
            border-right: none;
            border-bottom: 1px solid #dee2e6;
        }
        .right-panel {
            width: 100%;
            height: 60%;
        }
        .navbar-brand { font-size: 1.2rem; }
        .hide-on-mobile { display: none !important; }
        #results-resize-handle { display: none; }
        .results-panel { height: 40% !important; }
        .editor-wrapper { height: 60% !important; }
    }

    .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .example-box {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
    }

    .example-pre {
        background-color: #212529;
        color: white;
        padding: 10px;
        border-radius: 6px;
        margin-top: 5px;
        margin-bottom: 0;
        white-space: pre-wrap;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <i class="fas fa-code"></i>
        shyamonlinecompiler
      </a>
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-center">
          <li class="nav-item d-flex align-items-center">
             <span id="current-problem-display" class="text-light me-3 small d-none d-md-block opacity-75">No Problem Selected</span>
             <button id="back-to-list-btn" class="btn btn-outline-light btn-sm me-3 d-none">
                <i class="fas fa-arrow-left me-1"></i> Back
             </button>
          </li>
          
          <li class="nav-item" id="auth-section">
            <button id="login-btn" class="btn btn-primary-custom btn-sm px-3">
               <i class="fas fa-sign-in-alt me-1"></i> Login
            </button>
          </li>

          <li class="nav-item d-none" id="user-info">
             <div class="d-flex align-items-center">
                <span id="username-display" class="text-white me-3 fw-bold small"></span>
                <button id="logout-btn" class="btn btn-danger btn-sm">
                   <i class="fas fa-sign-out-alt"></i>
                </button>
             </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div id="main-content-wrapper">
    
    <div id="problem-list-page">
      <div class="problem-list-container">
        <div class="search-filter-bar">
           <h2 class="h4 fw-bold mb-3 text-dark">Available Problems</h2>
           <div class="row g-2">
             <div class="col-md-8">
               <div class="input-group">
                 <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                 <input type="text" id="problem-search" class="form-control border-start-0 ps-0" placeholder="Search problems...">
               </div>
             </div>
             <div class="col-md-4">
               <select id="difficulty-filter" class="form-select">
                 <option value="">All Difficulties</option>
                 <option value="easy">Easy</option>
                 <option value="medium">Medium</option>
                 <option value="hard">Hard</option>
               </select>
             </div>
           </div>
        </div>
        <div id="problems-list-container">
           <ul id="problems-list" class="list-unstyled">
             <li class="text-center p-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading problems...</li>
           </ul>
        </div>
      </div>
    </div>

    <div id="compiler-page" class="d-none">
       <div class="left-panel">
          <div class="panel-header">
             <h4 id="problem-title-small" class="m-0 fw-bold">Problem Title</h4>
             <div id="problem-meta-small" class="mt-1 small"></div>
          </div>
          <div id="problem-details-content" class="problem-content">
             <p class="text-center mt-5 text-muted">Loading details...</p>
          </div>
       </div>

       <div class="right-panel">
          <div class="editor-toolbar">
             <div class="d-flex align-items-center gap-2">
                <select id="language-select" class="custom-select-dark form-select-sm">
                  <option value="java">Java</option>
                  <option value="python">Python</option>
                  <option value="c">C</option>
                  <option value="cpp">C++</option>
                  <option value="javascript">JavaScript</option>
                  <option value="csharp">C#</option>
                </select>
                <div class="btn-group">
                   <button id="font-decrease" class="btn btn-sm btn-dark border-secondary" title="Decrease Font"><i class="fas fa-minus"></i></button>
                   <button id="font-increase" class="btn btn-sm btn-dark border-secondary" title="Increase Font"><i class="fas fa-plus"></i></button>
                </div>
             </div>
             <div class="d-flex gap-2">
                <button id="run-btn" class="btn btn-sm btn-warning fw-bold"><i class="fas fa-play me-1"></i> Run</button>
                <button id="submit-btn" class="btn btn-sm btn-primary-custom"><i class="fas fa-paper-plane me-1"></i> Submit</button>
             </div>
          </div>

          <div class="editor-wrapper">
             <div id="editor"></div>
          </div>

          <div id="results-resize-handle"></div>

          <div class="results-panel">
             <div class="results-tabs">
                <button class="tab-btn active" data-tab="test-results"><i class="fas fa-vial me-1"></i> Results</button>
                <button class="tab-btn" data-tab="custom-input"><i class="fas fa-keyboard me-1"></i> Input</button>
                <button class="tab-btn" data-tab="submissions"><i class="fas fa-history me-1"></i> History</button>
             </div>
             
             <div class="tab-content-area">
                <div id="test-results" class="tab-pane active">
                   <div id="test-results-content" class="h-100">
                      <div class="d-flex flex-column justify-content-center align-items-center h-100 text-muted opacity-50">
                         <i class="fas fa-code fa-3x mb-3"></i>
                         <p>Run code to see results</p>
                      </div>
                   </div>
                </div>

                <div id="custom-input" class="tab-pane">
                   <div class="d-flex flex-column h-100">
                      <textarea id="stdin" placeholder="Enter custom input for your program here..."></textarea>
                      <div class="bg-darker px-3 py-1 small text-muted border-top border-secondary">Used for 'Run' only</div>
                   </div>
                </div>

                <div id="submissions" class="tab-pane">
                   <div id="submissions-content" class="h-100 p-3">
                      <div class="text-center text-muted mt-5">Login to view history</div>
                   </div>
                </div>
             </div>
          </div>
       </div>
    </div>

  </div>

  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-4">
          <form id="login-form">
            <div class="mb-3">
              <label class="form-label small fw-bold text-muted">Username</label>
              <input type="text" class="form-control" id="login-username" required>
            </div>
            <div class="mb-3">
              <label class="form-label small fw-bold text-muted">Password</label>
              <input type="password" class="form-control" id="login-password" required>
            </div>
            <div class="alert alert-danger d-none" id="login-error"></div>
            <div class="d-grid">
              <button type="button" class="btn btn-primary-custom py-2" id="login-submit">Login</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    class CodeJudgeApp {
      constructor() {
        this.currentProblem = null; 
        this.problems = []; 
        this.problemCodeCache = {}; 
        this.currentLanguage = 'java'; 
        this.csrfToken = ''; 
        this.fontSize = 14; 
        this.currentUser = null; 
        this.authToken = null; 
        this.isResizing = false;
        this.loginModal = new bootstrap.Modal(document.getElementById('loginModal'));

        this.initEditor(); 
        this.bindEvents(); 
        this.initializeApp();
      }

      initEditor() {
        this.editor = ace.edit("editor"); 
        this.editSession = this.editor.getSession(); 
        this.editor.setTheme("ace/theme/twilight"); 
        this.editSession.setMode("ace/mode/java");
        this.editor.setOptions({ 
          fontSize: this.fontSize + 'pt', 
          showPrintMargin: false, 
          enableBasicAutocompletion: true, 
          enableLiveAutocompletion: true, 
          showLineNumbers: true, 
          tabSize: 4, 
          wrap: true
        });
        this.editor.on('change', () => this.saveCurrentCode());
      }

      bindEvents() {
        this.editorContainer = document.querySelector('.editor-wrapper');
        this.resultsPanel = document.querySelector('.results-panel');
        this.resultsHandle = document.getElementById('results-resize-handle');

        document.getElementById('back-to-list-btn').addEventListener('click', () => this.showView('list'));
        document.getElementById('language-select').addEventListener('change', (e) => this.handleLanguageSwitch(e.target.value));
        document.getElementById('run-btn').addEventListener('click', () => this.runCode());
        document.getElementById('submit-btn').addEventListener('click', () => this.submitCode());
        document.getElementById('font-increase').addEventListener('click', () => this.adjustFontSize(1));
        document.getElementById('font-decrease').addEventListener('click', () => this.adjustFontSize(-1));
        document.getElementById('problem-search').addEventListener('input', () => this.fetchProblems());
        document.getElementById('difficulty-filter').addEventListener('change', () => this.fetchProblems());
        document.getElementById('login-btn').addEventListener('click', () => this.loginModal.show());
        document.getElementById('logout-btn').addEventListener('click', () => this.logout());
        document.getElementById('login-submit').addEventListener('click', () => this.handleLogin());

        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', (e) => this.switchResultTab(e.target.closest('.tab-btn').dataset.tab));
        });

        if (this.resultsHandle) {
            this.resultsHandle.addEventListener('mousedown', (e) => this.startResizing(e));
        }
        document.addEventListener('mousemove', (e) => this.handleResize(e));
        document.addEventListener('mouseup', () => this.stopResizing());
        window.addEventListener('resize', () => {
            requestAnimationFrame(() => this.editor.resize());
        });
      }

      async initializeApp() { 
        this.showView('list');
        await this.fetchCsrfToken(); 
        this.checkAuthStatus(); 
        await this.fetchProblems(); 
      }

      startResizing(e) {
        this.isResizing = true;
        this.startY = e.clientY;
        this.startHeight = this.resultsPanel.offsetHeight;
        document.body.style.cursor = 'row-resize';
      }

      handleResize(e) {
        if (!this.isResizing) return;
        const deltaY = this.startY - e.clientY;
        let newHeight = this.startHeight + deltaY;
        if (newHeight < 40) newHeight = 40;
        if (newHeight > window.innerHeight - 200) newHeight = window.innerHeight - 200;
        this.resultsPanel.style.height = `${newHeight}px`;
        this.editor.resize();
      }

      stopResizing() {
        this.isResizing = false;
        document.body.style.cursor = '';
      }

      showView(viewName) {
        const listPage = document.getElementById('problem-list-page');
        const compilerPage = document.getElementById('compiler-page');
        const backBtn = document.getElementById('back-to-list-btn');
        const display = document.getElementById('current-problem-display');

        if (viewName === 'list') {
            listPage.classList.remove('d-none');
            compilerPage.classList.add('d-none');
            backBtn.classList.add('d-none');
            display.textContent = 'No Problem Selected';
        } else {
            listPage.classList.add('d-none');
            compilerPage.classList.remove('d-none');
            backBtn.classList.remove('d-none');
            requestAnimationFrame(() => this.editor.resize()); 
        }
      }

      switchResultTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
        if (tabId === 'submissions' && this.currentUser) this.loadSubmissions();
      }

      adjustFontSize(delta) { 
        this.fontSize = Math.max(10, Math.min(24, this.fontSize + delta)); 
        this.editor.setOptions({ fontSize: this.fontSize + 'pt' }); 
      }

      async fetchCsrfToken() { 
        try { 
          const response = await fetch('/api/csrf-token'); 
          const data = await response.json(); 
          this.csrfToken = data.csrf_token; 
        } catch (error) { console.error(error); } 
      }
      
      checkAuthStatus() { 
        const token = localStorage.getItem('authToken'); 
        const user = localStorage.getItem('currentUser'); 
        if (token && user) { 
          try { 
            this.authToken = token; 
            this.currentUser = JSON.parse(user); 
            this.updateAuthUI(); 
          } catch (e) { this.clearAuth(); } 
        } 
      }

      updateAuthUI() {
        const authSection = document.getElementById('auth-section');
        const userInfo = document.getElementById('user-info');
        const usernameDisplay = document.getElementById('username-display');
        const submitBtn = document.getElementById('submit-btn');

        if (this.currentUser) { 
          authSection.classList.add('d-none'); 
          userInfo.classList.remove('d-none'); 
          usernameDisplay.textContent = this.currentUser.username; 
          submitBtn.disabled = false; 
        } else { 
          authSection.classList.remove('d-none'); 
          userInfo.classList.add('d-none'); 
          submitBtn.disabled = true; 
        }
      }

      async handleLogin() {
        const u = document.getElementById('login-username').value; 
        const p = document.getElementById('login-password').value;
        if (!u || !p) return;

        const btn = document.getElementById('login-submit');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
          const res = await fetch('/api/auth/login', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': this.csrfToken }, 
            body: JSON.stringify({ username: u, password: p }) 
          });
          const data = await res.json();
          btn.disabled = false; btn.innerText = 'Login';
          
          if (res.ok) { 
            this.authToken = data.token; 
            this.currentUser = data.user; 
            localStorage.setItem('authToken', this.authToken); 
            localStorage.setItem('currentUser', JSON.stringify(this.currentUser)); 
            this.updateAuthUI(); 
            this.loginModal.hide(); 
          } else { 
            const errEl = document.getElementById('login-error');
            errEl.textContent = data.error || 'Login failed';
            errEl.classList.remove('d-none');
          }
        } catch (error) { 
            btn.disabled = false; btn.innerText = 'Login';
        }
      }

      logout() { 
        this.clearAuth(); 
      }

      clearAuth() { 
        this.currentUser = null; 
        this.authToken = null; 
        localStorage.removeItem('authToken'); 
        localStorage.removeItem('currentUser'); 
        this.updateAuthUI(); 
      }

      async fetchProblems() {
        const list = document.getElementById('problems-list');
        list.innerHTML = `<li class="text-center p-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</li>`;

        const search = document.getElementById('problem-search').value; 
        const diff = document.getElementById('difficulty-filter').value;
        
        try {
          const params = new URLSearchParams({ page: 1, page_size: 50 }); 
          if (search) params.append('search', search); 
          if (diff) params.append('difficulty', diff);
          
          const res = await fetch(`/api/problems?${params}`); 
          const data = await res.json();
          this.problems = data.problems || []; 
          this.renderProblemsList(); 
        } catch (error) { 
          list.innerHTML = `<li class="text-center p-4 text-danger">Error loading problems.</li>`;
        }
      }

      renderProblemsList() {
        const list = document.getElementById('problems-list'); 
        list.innerHTML = '';
        
        if (this.problems.length === 0) {
            list.innerHTML = `<li class="text-center p-4 text-muted">No problems found.</li>`;
            return;
        }

        this.problems.forEach((p) => {
          const li = document.createElement('li'); 
          li.className = 'problem-item';
          const badgeClass = p.difficulty === 'easy' ? 'diff-easy' : p.difficulty === 'medium' ? 'diff-medium' : 'diff-hard';
          li.innerHTML = `
            <div>
              <div class="fw-bold text-dark">${p.title}</div>
              <span class="badge-difficulty ${badgeClass} mt-1 d-inline-block">${p.difficulty}</span>
            </div>
            <button class="btn btn-primary-custom btn-sm rounded-pill px-3"><i class="fas fa-arrow-right"></i></button>
          `;
          li.onclick = () => this.loadProblemBySlug(p.slug);
          list.appendChild(li);
        });
      }

      async loadProblemBySlug(slug) {
        this.saveCurrentCode();
        try {
          document.getElementById('problem-details-content').innerHTML = '<p class="text-center mt-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</p>';
          
          const res = await fetch(`/api/problem/${slug}`); 
          const data = await res.json();
          if (data.error) return;
          
          this.currentProblem = data.problem; 
          this.renderProblemContent(); 
          this.loadCodeForProblem();
          document.getElementById('current-problem-display').textContent = this.currentProblem.title;
          this.showView('compiler');
          this.editor.focus();
        } catch (error) {}
      }

      renderProblemContent() {
        const p = this.currentProblem; 
        const wrapper = document.getElementById('problem-details-content'); 
        document.getElementById('problem-title-small').textContent = p.title;
        
        const diffColor = p.difficulty === 'easy' ? 'text-success' : p.difficulty === 'medium' ? 'text-warning' : 'text-danger';
        document.getElementById('problem-meta-small').innerHTML = `
            <span class="fw-bold text-uppercase ${diffColor}">${p.difficulty}</span>
            <span class="ms-2 text-muted">| Time: ${p.time_limit || 1}s | Memory: ${p.memory_limit || '256m'}</span>
        `;

        let exHtml = ''; 
        if (p.examples && p.examples.length) { 
           exHtml = `<div class="mt-4"><h6 class="fw-bold text-dark mb-3">Examples</h6>
            ${p.examples.map((e, i) => `<div class="example-box"><div class="fw-bold small text-muted">Example ${i+1}</div><pre class="example-pre">${this.escapeHtml(e)}</pre></div>`).join('')}</div>`;
        }
        
        wrapper.innerHTML = `<div class="mt-3">${p.statement || 'No description.'}</div>${exHtml}`;
      }
      
      saveCurrentCode() { 
        if (this.currentProblem) { 
          const key = `${this.currentProblem.slug}_${this.currentLanguage}`; 
          this.problemCodeCache[key] = { [this.getFilename(this.currentLanguage)]: this.editor.getValue() }; 
        } 
      }

      getFilename(lang) {
        const map = { 'java': 'Main.java', 'python': 'app.py', 'c': 'main.c', 'cpp': 'main.cpp', 'javascript': 'index.js', 'csharp': 'Submission.cs' };
        return map[lang] || 'main.txt';
      }

      handleLanguageSwitch(lang) {
        if (lang === this.currentLanguage) return;
        this.saveCurrentCode();
        this.currentLanguage = lang; 
        this.setEditorMode(lang); 
        this.loadCodeForProblem();
      }

      setEditorMode(lang) { 
        const modes = { 'java': 'ace/mode/java', 'python': 'ace/mode/python', 'c': 'ace/mode/c_cpp', 'cpp': 'ace/mode/c_cpp', 'javascript': 'ace/mode/javascript', 'csharp': 'ace/mode/csharp' }; 
        this.editSession.setMode(modes[lang] || 'ace/mode/text'); 
      }

      loadCodeForProblem() {
        if (!this.currentProblem) { this.editor.setValue("// Select problem...", -1); return; }
        const key = `${this.currentProblem.slug}_${this.currentLanguage}`;
        let code = this.problemCodeCache[key] ? this.problemCodeCache[key][this.getFilename(this.currentLanguage)] : (this.currentProblem[`template_${this.currentLanguage}`] || this.getTemplate(this.currentLanguage));
        this.editor.setValue(code, -1);
      }
      
      getTemplate(lang) {
          const t = { 
              'java': 'import java.util.*;\n\nclass Solution {\n    public void solve() {\n        // Code here\n    }\n}\n\npublic class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello World");\n    }\n}', 
              'python': 'def solve():\n    # Code here\n    pass\n\nif __name__ == "__main__":\n    print("Hello World")',
              'cpp': '#include <iostream>\nusing namespace std;\n\nint main() {\n    cout << "Hello World" << endl;\n    return 0;\n}'
          };
          return t[lang] || '// Write code here';
      }

      async runCode() {
        if (!this.currentProblem) return;
        this.saveCurrentCode();
        this.executeCode('run', 'Running...');
      }

      async submitCode() {
        if (!this.currentProblem || !this.currentUser) { this.loginModal.show(); return; }
        this.saveCurrentCode();
        this.executeCode('submit', 'Submitting...');
      }
      
      async executeCode(ep, msg) {
        this.showLoading(msg);
        this.switchResultTab('test-results');
        const fname = this.getFilename(this.currentLanguage);
        const payload = { 
            language: this.currentLanguage, 
            files: this.problemCodeCache[`${this.currentProblem.slug}_${this.currentLanguage}`] || { [fname]: this.editor.getValue() }, 
            problem_slug: this.currentProblem.slug, 
            stdin: document.getElementById('stdin').value 
        };

        try {
          const headers = { 'Content-Type': 'application/json', 'X-CSRF-Token': this.csrfToken };
          if (this.authToken) headers['Authorization'] = `Bearer ${this.authToken}`;
          
          const res = await fetch(`/api/${ep}`, { method: 'POST', headers, body: JSON.stringify(payload) });
          const result = await res.json();
          
          if (!res.ok) { 
             if (res.status === 401) this.logout();
             this.showError(result.error || 'Failed'); 
          } else {
             this.displayResults(result, ep);
          }
        } catch (e) { this.showError('Network Error'); }
      }

      displayResults(res, type) {
        const content = document.getElementById('test-results-content');
        
        if (res.compiled === false) { 
          content.innerHTML = `<div class="p-3 bg-dark border border-danger rounded m-3 text-danger"><h6 class="fw-bold"><i class="fas fa-times-circle me-2"></i>Compilation Error</h6><pre class="text-white mt-2 small">${this.escapeHtml(res.compile_error)}</pre></div>`; return; 
        }
        
        if (type === 'submit') {
             const isAC = res.verdict === 'AC';
             const color = isAC ? 'text-success' : 'text-danger';
             content.innerHTML = `<div class="d-flex flex-column justify-content-center align-items-center h-100"><i class="fas ${isAC ? 'fa-check-circle' : 'fa-times-circle'} fa-4x ${color} mb-3"></i><h2 class="${color}">${res.verdict || 'Error'}</h2><p class="text-muted">${res.passed}/${res.total} Passed</p></div>`;
             if(this.currentUser) this.loadSubmissions();
        } else {
             if (res.tests && res.tests.length) {
                content.innerHTML = `<div class="p-3">${res.tests.map((t,i) => {
                    const pass = t.status === 'PASS';
                    return `<div class="test-case-card ${pass?'bg-pass':'bg-fail'}"><div class="test-case-header"><span class="fw-bold">Test Case ${i+1}</span><span class="${pass?'status-pass':'status-fail'} fw-bold"><i class="fas ${pass?'fa-check':'fa-times'} me-1"></i>${pass?'Passed':(t.error||'Failed')}</span></div><div class="test-case-body text-white"><div><div class="text-muted small">Input</div><div>${this.escapeHtml(t.input)}</div></div><div class="mt-2"><div class="text-muted small">Output</div><div>${this.escapeHtml(t.output)}</div></div></div></div>`;
                }).join('')}</div>`;
             } else {
                content.innerHTML = `<div class="p-3"><h6 class="text-white border-bottom border-secondary pb-2">Output</h6><pre class="text-light">${this.escapeHtml(res.output)}</pre></div>`;
             }
        }
      }

      async loadSubmissions() {
        const content = document.getElementById('submissions-content');
        try {
           const res = await fetch('/api/submissions', { headers: { 'Authorization': `Bearer ${this.authToken}` } });
           const data = await res.json();
           if(!data.submissions.length) { content.innerHTML = '<div class="text-center text-muted mt-5">No submissions</div>'; return; }
           content.innerHTML = `<div class="list-group list-group-flush">${data.submissions.map(s => {
               const cls = s.verdict==='AC'?'success':s.verdict==='DEP'?'warning':'danger';
               return `<div class="list-group-item bg-transparent text-light border-secondary"><div class="d-flex justify-content-between"><span>${s.title}</span><span class="badge bg-${cls}">${s.verdict}</span></div><small class="text-muted">${s.language} - ${new Date(s.created_at).toLocaleDateString()}</small></div>`;
           }).join('')}</div>`;
        } catch(e) { content.innerHTML = '<div class="text-center text-danger mt-3">Failed to load</div>'; }
      }

      showLoading(msg) { document.getElementById('test-results-content').innerHTML = `<div class="d-flex justify-content-center align-items-center h-100 text-muted"><div class="text-center"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><p>${msg}</p></div></div>`; }
      showError(msg) { document.getElementById('test-results-content').innerHTML = `<div class="p-3 text-danger text-center">${msg}</div>`; }
      escapeHtml(t) { if(!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
    }

    document.addEventListener('DOMContentLoaded', () => { window.codeJudgeApp = new CodeJudgeApp(); });
  </script>
</body>
</html>